# Template file for 'session-desktop'
pkgname=session-desktop
version=1.16.6
revision=1
# Session officially only supports x86_64
# x86_64-musl could potentially work based on the Alpine Signal port:
# https://git.alpinelinux.org/aports/tree/testing/signal-desktop
# ARM: https://github.com/signalapp/Signal-Desktop/issues/3410
archs="x86_64"
hostmakedepends="git python3 yarn cmake tar"
depends="gtk+3 pango cairo libvips desktop-file-utils hicolor-icon-theme"
checkdepends="glib nss libgbm alsa-lib $depends"
short_desc="Session Private Messenger for Linux"
maintainer="xJayMorex <github@johntaylor.hu>"
license="GPL-3.0-or-later"
homepage="https://github.com/session-foundation/session-desktop"
distfiles="https://github.com/session-foundation/session-desktop/archive/v${version}.tar.gz"
checksum="4f247a5b344a92e87bf62d73ee1aed5799871b689b7f0bef98dfdadf8a929018"
nostrip_files="session-desktop"

pre_build() {
	vsed 's/"node": ".*"/"node": ">=20.0.0"/' -i package.json

	# Install dependencies for session-desktop
	yarn install
}

do_build() {
	# Build session-desktop
	yarn build
	yarn build-release
}

do_check() {
	yarn test
}

do_install() {
	vmkdir usr/lib/session-desktop
	vcopy release/linux-unpacked/* usr/lib/session-desktop

	vmkdir usr/bin
	ln -s /usr/lib/session-desktop/session-desktop ${DESTDIR}/usr/bin/

	vinstall ${FILESDIR}/session-desktop.desktop 644 usr/share/applications
	vinstall ${FILESDIR}/libc.musl-x86_64.so.1 755 usr/lib

	for size in 16 32 48 64 128 256 512 1024; do
		vinstall build/icons/icon_${size}x${size}.png 644 usr/share/icons/hicolor/${size}x${size}/apps session-desktop.png
	done

	vlicense LICENSE
}
